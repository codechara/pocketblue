on:
  workflow_call:
    inputs:
      device:
        required: true
        type: string
      fedora_branch:
        required: true
        type: string
      pocketblue_tag:
        required: true
        type: string
      latest:
        required: false
        type: boolean
        default: false
      expires_after:
        required: false
        type: string

jobs:
  config:
    runs-on: ubuntu-24.04-arm
    steps:
      - id: config
        run: |
          registry_val="${{ vars.REGISTRY != '' && vars.REGISTRY || format('ghcr.io/{0}', github.repository_owner) }}"
          echo "registry=$registry_val" >> "$GITHUB_OUTPUT"
    outputs:
      registry: ${{ steps.config.outputs.registry }}
  device-base:
    name: '${{ inputs.device }}: base'
    permissions:
      packages: write
    secrets: inherit
    uses: ./.github/workflows/helper-build-container.yml
    with:
      push_tag: ${{ inputs.pocketblue_tag }}
      from_tag: ${{ inputs.pocketblue_tag }}
      from_image: ${{ needs.config.outputs.registry }}/base
      image: ${{ inputs.device }}-base
      containerfile: devices/${{ inputs.device }}/Containerfile
      latest: ${{ inputs.latest }}
      expires_after: ${{ inputs.expires_after }}

  desktops:
    name: '${{ inputs.device }}: desktops'
    needs: device-base
    permissions:
      packages: write
    secrets: inherit
    strategy:
      fail-fast: false
      matrix:
        desktop: [ gnome-mobile, gnome-desktop, phosh, plasma-desktop, plasma-mobile ]
    uses: ./.github/workflows/helper-build-container.yml
    with:
      push_tag: ${{ inputs.pocketblue_tag }}
      from_tag: ${{ inputs.pocketblue_tag }}
      from_image: ${{ needs.config.outputs.registry }}/${{ inputs.device }}-base
      image: ${{ inputs.device }}-${{ matrix.desktop }}
      containerfile: desktops/${{ matrix.desktop }}/Containerfile
      latest: ${{ inputs.latest }}
      expires_after: ${{ inputs.expires_after }}
      rechunk: true
