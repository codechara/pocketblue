#!/usr/bin/env bash

set -uexo pipefail
fastboot getvar product 2>&1 | grep sdm845

export device=@device@
# export device=enchilada # for oneplus6
# export device=fajita    # for oneplus6t

echo $device | grep -E 'enchilada|fajita'

which fastboot

echo 'waiting for device appear in fastboot'
fastboot getvar product 2>&1 | grep sdm845
fastboot erase dtbo_a
fastboot erase dtbo_b
fastboot erase op2 2> /dev/null || true
fastboot flash boot     images/uboot-$device.img --slot=all
fastboot flash system_a images/fedora_boot.raw
fastboot flash system_b images/fedora_esp.raw
fastboot flash userdata images/fedora_rootfs.raw

echo 'done flashing, rebooting now'
fastboot reboot
