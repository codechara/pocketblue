@(set "0=%~f0"^)#) & powershell -nop -c iex([io.file]::ReadAllText($env:0)) & exit /b
$ErrorActionPreference = "Stop"

trap {
  Write-Host $_.Exception.Message
  Read-Host
}

$device = '@device@'
# $device = 'enchilada' # for oneplus6
# $device = 'fajita'    # for oneplus6t

Get-Command fastboot

echo 'waiting for device appear in fastboot'
$ErrorActionPreference = "Continue"
if (-not (fastboot getvar product 2>&1 | Select-String sdm845)) { throw 'wrong device' }
$ErrorActionPreference = "Stop"
fastboot erase dtbo_a
fastboot erase dtbo_b
fastboot flash boot     images/uboot_$device.img --slot=all
fastboot flash system_a images/boot.raw
fastboot flash system_b images/esp.raw
fastboot flash userdata images/root.raw

echo 'success'
Read-Host
